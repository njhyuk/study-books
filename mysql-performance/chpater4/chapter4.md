# 4장 접근 패턴

## 4-1 MySQL은 아무것도 하지 않는다

* 애플리케이션이 유휴상태일때 MySQL은 유휴 상태이다.
* 일부 페이지 플러싱 같은 백그라운드 작업은 있으나, 쿼리들에 대한 데이터를 읽고 쓰는데도 바쁘다.
* 느린 쿼리의 원인은 애플리케이션이다.
* 쿼리 경합
  * 쿼리는 다른 쿼리에 영향을 준다.
  * 로우 락 경합, CPU 경합
  * MySQL은 로우 락 경합이라는 한가지 유형의 경합만 보고한다.
    * 쿼리 경합을 보거나 증명하는 것은 거의 불가능하다.
    * 이유 : 로우락 경합도 로우 락이 복잡하기 때문에 정확하게 확인하기 어렵다.

## 4-2 한계에 도달하면 성능이 불안정해진다

* 선형 스케일링
  * DB 성능은 하드웨어 처리량을 100% 사용할때 까지 증가한 다음, 성능이 일정하게 유지된다.
    * 이를 선형 스케일링 이라 한다.
  * 선형스케일링은 이상적이지만 실현되기 어렵다.
    * 현실적으로 DB 성능의 한계는 시스템 처리량의 80~95% 정도이다.
    * 부하가 한도를 초과하여 증가하면 성능이 불안정해진다.
* 운영 중단의 전조 증상
  * 상승기
    * 메트릭이 꾸준히 상승
  * 한계점
    * CPU 사용량과 QPS는 꾸준히 높은 상태로 유지중
    * 실행중인 스레드의 톱날패턴이 MySQL이 불안정해졌음을 나타내는 신호
    * 하나의 쿼리를 실행하는데는 하나의 스레드가 필요함
      * 실행중인 스레드의 큰 변동은 쿼리가 원활하지 않다는 뜻
  * 수정
    * 개발자가 애플리케이션 레벨 트랜잭션 처리량을 줄임
    * CPU 사용량이 50%로 떨어지고 QPS와 스레드도 안정됨
* 한계에 도달한 Mysql 성능에 대해
  1. 일부러 부족한 하드웨어를 사용하지 않는 한, 한계에 도달하기 어렵다.
     * 애플리케이션은 모든 하드웨어를 동시에 완전히 활용하기 전에, 병목 현상을 일으킨다.
       * DB 성능의 한계가 아닌 하드웨어의 한계에 도달한 것이다.
  2. 높은 부하로 인해 MySQL이 느리게 응답한다고 해서 한계에 도달했다는 의미는 아니다.
     * 동시성이 증가하면 한계가 증가함, 느려진게 한계가 도달했다는건 아님

## 4-3 도요타와 페라리

* 두 자동차 브랜드 거의 똑같은 부품과 디자인을 사용한다.
* 하지만 페라리가 더 빠르다.
* 도요타는 고속 주행을 목표로 설계되지 않았고, 페라리는 모든 부분이 고속 주행을 목표로 설계되었다.
* MySQL의 성능을 높이기 위해 같은 관점으로 데이터 접근패턴을 설계할 수 있다.

## 4-4 데이터 접근 패턴

* 애플리케이션이 MySQL을 사용하여 DB에 접근하는 방법이다.
* 접근 패턴에 대한 3가지 세부 정보
    1. 접근 패턴은 개별적으로 수정해야 한다.
    2. 쿼리가 초점이 아니다.
       1. 쿼리는 구현이다. 인터페이스에 집중해야 한다.
          1. ex) 특정 접근 패턴은 MySQL 보다 key-value 스토리지가 적합
    3. 접근 패턴은 이름과 기술적인 특성 목록으로 구성된다.
       1. 이름 : 접근 패턴을 다른 엔지니어와 소통하는데 사용
       2. 기술적인 특성 목록 : 데이터 스토리지에 따라 접근 방법이 다름 (MySQL vs key-value)
