# 3장 구글맵
일간 능동 사용자수는 10억명이다. 전세계 99% 지역의 지도를 제공하고, 정화한 실시간 위치 정보르 제공하기 위해 매일 2500만 건의 업데이트를 반영한다.

## 1단계: 문제 이해 및 설계 범위 확정 
* 일간 능동 사용자수 가정
  * 10억 DAU 가정
* 기능 최소화
  * 위치 갱신, 경로 안내, ETA, 지도표시
* 도로 데이터 규모
  * 수 TB 수준의 가공되지 않은 데이터
* 교통 상황
  * ETA에 고려 필요
* 이동 수단
  * 운전, 도보, 대중교통 지원
* 경유지
  * 신경쓰지 않기로 함
* 사업장 위치 및 사진 표시
  * 고려하지 않기로 함
### 기능 요구사항
* 사용자 위치 갱신
* 경로 안내 서비스, ETA
* 지도 표시
### 비기능 요구사항 및 제약사항
* 정확도 : 정확한 경로 표시
* 부드러운 경로 표시 : 화면에 부드러운 표시, 갱신
* 데이터 및 배터리 사용량 : 최소한의 데이터 및 배터리 (모바일)
* 일반적인 가용성과 규모 확장성

### 지도 101 (지도관련 기본 개념)
* 측위 시스템
  * 구 표면상의 위치를 표현하는 체계
  * 위경도 기반 측위 시스템 - 최상단 : 북극, 최하단 : 남극
  * 위도 : 얼마나 북쪽/남쪽인지
  * 경도 : 얼마나 동쪽/서쪽인지
* 3차원 위치의 2차원 변환
  * 3차원 구의 위치를 2차원 평면에 대응시키는 절차 : 지도 투영법(도법)
  * 도법 각각은 다른 도법과는 차별되는 장단점을 가짐
  * 실제 지형의 기하학적 특성을 왜곡한다는 공통점 [그림 3.2]
* 지오코딩
  * 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스
    * 주소 -> 위도,경도
  * 역 지오코딩
    * 위도,경도 -> 주소
  * 지오코딩을 수행하는 방법 -> 인터폴레이션
* 지오해싱
  * 지도 위 특정 영역을 영문자와 숫자로 구성된 짧은 문자열에 대응 시킴
  * 지리적 영역 위의 격자 ->  더 작은 격자로 재귀적 분할 [그림 3.3]
* 지도표시
  * 지도 전부를 하나의 이미지가 아닌 작은 타일로 쪼개어 표시함
  * 클라이언트는 보려는 영역에 관계된 타일만 다운 받아 이어 붙임
  * 확대/축소 기능을 위해 확대 수준에 따라 다른 종료의 타일을 준비함
    * 전체 지도를 한눈에 다 보려는 경우 -> 전세계를 256x256 픽셀 이미지 하나로 다운
* 경로 안내 알고리즘을 위한 도로 데이터 처리
  * 대부분의 경로 탐색 알고리즘
    * 데이터스트라 알고리즘, A* 경로 탐색 알고리즘의 변종
    * 그래프 자료구조 사용
      * 교차로 : node
      * 도로를 잇는 섯 : edge
  * 알고리즘의 성능
    * 주어진 그래프 크기에 민감함
    * 전세계 도로망을 하나의 그래프로 표현하려면
      * 메모리 과다 사용
      * 나쁜 검색 성능
      * 그래프를 관리 가능 단위로 분할해야함
        * 타일 기반 분할법과 유사
        * 세계를 작은 격자 단위로 나눔
        * 각 격자 안의 도로망을 그래프로 표현
        * 각 격자는 안내 타일이라고 부름
        * 각 타일은 도로로 연결된 다른 타일의 참조 유지
  * 지도 타일은 png, 경로 안내 타일은 이진 파일
* 계층적 경로 안내 타일
  * 국토 종단 여행을 위한 탐색은 너무 느림
  * 구체성 정도를 상,중,하로 구분하여 타일을 준비함
    * 상 타일 : 지방 도로 데이터
    * 중 타일 : 더 넓은 지역, 간선도로 데이터
    * 하 타일 : 도시와 주를 연결 하는 주요 고속도로 데이터
### 개략적 규모 추정
* 세계지도 이미지 보관
* 지원하는 확대 수준별로 지도 타일 한벌씩 보관
* 최대 확대 수준에 필요한 타일 개수를 따져보면 좋다
* 확대 할때 마다 하나의 타일을 4장의 타일로 펼치는 것으로 가정
  * 21번 확대 = 4.4조개 타일
* 한장의 타일 (256x256) = 100kb
* 총 4.4조 x 100kb = 440pb 저장공간이 필요함
* 지구 표면 가운데 인간이 살지 않는 90% 는 아주 높은 비율로 압축 가능
  * 80%, 90% 가량의 저장용량 절감 가능
    * 440pb -> 88pb 로 절감
* 다른 확대수준의 이미지도 저장 필요
  * 확대수준이 1 떨어질때 마다 타일 수는 N/4
  * 대략 100PB 정도 소요
#### 서버 대역폭
* 서버가 처리 필요한 요청
  * 경로 안내 요청
  * 위치 갱신 요청
* DAU10억명이 주당 35분 사용, 주당 350억분, 하루에 50억분
* GPS 좌표를 매초 전송
  * 50억분*60=하루 3천억건 요청
  * 3천억건/10^5 = 3백만 QPS
## 2단계: 개략적 설계안 제시 및 동의 구하기
### 개략적 설계안
[그림3.7]
* 위치 서비스
  * 사용자의 위치를 기록하는 역할
  * t초마다 자기 위치를 주기적으로 전송한다 가정한다면?
    * 데이터 스트림을 활용하여 점차 개선 가능
    * 실시간 교통상황 모니터링 가능
    * 폐쇠된 도로 탐지
    * 개인화 경험 제공
    * ETA를 정확하게 산출 가능
  * 위치를 일괄 요청한다고 가정 한다면?
    * 클라이언트가 보내는 요청의 양을 줄일 수 있음 
  * 아주 높은 쓰기 빈도수
    * 카산드라 같은 DB가 적합
    * 또는 카프카 같은 스트림 처리 엔진으로 데이터 로깅
  * 통신 프로토콜, HTTP 를 kkeep-alive 옵션과 함께 사용
  * POST /v1/locations
    * 인자 : JSON 으로 인코딩한(위도, 경도, 시각) 순서 쌍배열
* 경로 안내 서비스
  * A에서 B 지점으로 가는 합리적으로 빠른 경로를 찾아 주는 역할
  * 결과를 얻는 데 드는 시간 지연은 감내 가능함
  * 정확도는 보장 되어야함
  * GET /v1/nav?origin=1355+market+street, SF&destination=Disneyland
    * 출발지와 목적지가 인자로 전달
    * 응답으로 남은 km, ETA, 출발지 위경도, 도착지 위경도
* 지도 표시
  * 확대 수준별로 한벌씩 지도 타일 : 수백 PB
    * 클라이언트가 모두 저장하는게 아닌 서버에 저장
  * 클라이언트가 언제 지도 타일을 요청하는지
    * 사용자가 지도를 확대, 이동하며 탐색
    * 경로 안내가 진행되는 동안, 위치가 타일을 벗어나 인접한 타일로 이동
  * 효과적으로 지도 가져오기
    * 선택지1
      * 클라이언트의 위치, 지도의 확대 수준에 근거
        * 필요한 지도 타일을 즉석에서 만들기
      * 문제
        * 모든 지도 타일을 동적으로 만드는데 부하 부담
        * 캐시 활용 어려움
    * 선택지2
      * 확대 수준별로 미리 만들어둔 지도 타일을 전달
      * 지오해싱 같은 분할법을 사용해 만든 고정된 사각형 격자로 표현, 정적
      * 현재 확대 수준에 근거하여 피요한 타일 집합 결정
        * 각 위치를 지오해시 URL로 변환
      * 미리 만들어둔 이미지는 CDN을 통해 그림3.10 처럼 제공
    * CDN
      * 모바일 단말 사용자 
        * 지도 타일 요청을 CDN에 보냄
        * CDN을 통해 서비스 된 적이 없는 경우, CDN은 원본 서버에서 해당 파일을 가져와 그 사본을 캐시에 보관함
        * 다음 사용자가 요청하면 CDN은 캐시에 보관한 사본을 서비스하며, 원본 서버는 다시 접촉하지 않음
          * aws cloudfront 아키텍처 : [AWS CloudFront Architecture](https://crishantha.medium.com/aws-cloudfront-architecture-75d59e1df053)
      * 트래픽 규모
        * 매일 50억분 경로안내 x 1.25MB = 일 6.25PB
        * 초당 62,500MB
      * 이미지 요청
        * 클라이언트가 타일에 대응되는 지오해시 계산해서 요청 (때로는 위험하다)
          * https://cdn.com/9q9hvy.png
        * 대체 방법
          * 위도/경도 및 확대수준을 타일 URL로 변환하는 알고리즘 API
## 3단계 : 상세 설계
### 데이터 모델 (3가지)
#### 경로 안내 타일
* 외부 사업자나 기관이 제공하는 도로 Raw 데이터
  * 그래프 자료 구조 형태로 가공되지 않은 데이터
  * 도로 및 메타데이터 (이름, 관할구, 위도, 경도)
  * 사용자 위치 데이터를 통해 지속적으로 개선됨
* 데이터 가공 파이프라인 -> 경로 안내 타일로 변환
  * S3같은 객체 저장소에 파일 보관
  * 파일을 이용할 경로 안내 서비스에서 적극적 캐싱
#### 사용자 위치 데이터
* 도로 데이터 및 경로 안내 타일 갱신에 이용
* 실시간 교통상황에 이용
* 엄청난 양의 쓰기 연산 필요, 카산드라 사용
#### 미리 만들어 둔 지도 이미지
* 단말이 특정 영역의 지도 요청
  * 상세 정보가 포함된 이미지 생성
  * 이미지는 CDN을 통해 전송
  * 중복 요청이 많으므로 캐시 필요
### 서비스
위치 서비스, 지도 표시, 경로안내 서비스가 있음
#### 위치 서비스
* 사용자 위치 데이터는 키-값 저장소를 활용함
* 초당 백만건의 위치정보 업데이트 -> NoSQL 키-값 DB, 열중심 DB 적합
* 사용자 위치는 계속 변화함, 이전 정보는 무가치해짐
  * 일관성 보다 가용성이 중요함
  * CAP 중 AP 만족하는 카산드라 채택
* 데이터의 키 (user_id, timestamp)
  * 값 (위도/경도 쌍)
  * user_id 는 파티션키
  * timestamp 는 클러스터링 키
##### 사용자 위치 데이터는 어떻게 이용되는가
* 추후 개선에 유용
  * 새로 개설되거나 폐쇄된 도로 감지
  * 실시간 교통 현황 파악
* DB 기록과 별개로 카프카에 로깅해두자
* 각자 용도에 맞게 사용
  * 실시간 교통량 consumer
  * 폐쇄도로 탐지 consumer
  * 개인화 consumer
##### 지도 표시
타일 사전 계산. 지도 표시 최적화 기법 소개
##### 지도 타일 사전 계산
* 타일 수 : 1단계 상승시 마다 동서방향 2배, 남북방향 2배
* 해상도 : 4배
![](chapter3/image.png)
##### 최적화: 벡터 사용
* webGL 을 사용하면 이미지 대신 경고, 다각형, 벡터를 보낼 수 있다.
* 월등한 압축률과 대역폭 저라감
* 훨신 매끄러운 지도 경험 (fotmxj dlalwl 계단현상)
#### 경로 안내 서비스
아래 각 컴포넌트를 소개함
![](chapter3/image%202.png)
#### 지오코딩 서비스 
주소를 위도, 경도 쌍으로 바꿔줌
![](chapter3/image%203.png)
#### 경로 계획 서비스
교통 상황에 따라 최적화 경로 제안 (아래 설명 서비스와 결합)
#### 최단 경로 서비스
* 출발지와 목적지 위도/경도를 입력 받아 k개 최단경로 반환
* 도로상황 고려 X, 순수 도로 구조 계싼
* 정적인 도로망 그래프는 캐싱
* 입력
  * 출발지, 목적지 위도/경도
  * 지오해시로 변환 -> 다음 출발지와 목적지 경로 안내 타일을 얻음
* 출발지 타일에서 시작
  * 그래프 자료구조 탐색
* 탐색 범위를 넓힘
  * 주변 타일을 객체 저장소에서 가져옴
* 반복 작업
  * 최단 경로가 확보될때 까지 검색범위를 계속 확대
#### 예상 도착 시간 서비스
* 최단 경로 서비스의 최단 경로 목록 기반
* 경로 각각에 따라 기계학습, 교통 상황 기반 ETA 계산
#### 순위 결정 서비스
* 순위 결정 서비스에서 남은 경로를 소요 시간순으로 정렬
#### 중요 정보 갱신 서비스들
* 카프카를 통해 폐쇄된 도로 반영
* 실시간 교통상황 반영
#### 적응형 ETA와 경로 변경
사용자를 추적하며 교통상황에 달라질 때 마다 ETA 변경 반영
![](chapter3/image%204.png)
다른 접근법, 상위타일을 재귀적으로 추적, O(n)
![](chapter3/image%205.png)
#### 전송 프로토콜
경로 안내중 경로의 상황에 변경됨
* 모바일 푸시 알림 : 메시지 크기 제한적, 웹은 안됨 
* 롱 폴링 : 서버에 주는 부담이 있음
* 웹소켓, SSE : 부담이 크지 않음, 일반적 방안
![](chapter3/image%206.png)
## 4단계: 마무리
* 이 시스템의 확장에 관심이 있다면, 기업 고객 대상으로 중간 경유지 설정 기능을 제공하는 것을 고려해 보면 좋을 것 
* 여러 목적지를 입력 하면 그 모두를 어떤 순서로 방문해야 가장 빨리 경유할 수 있을지 
  * 배민, 쿠팡.. 물류 서비스의 과제들
